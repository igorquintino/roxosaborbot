import React, { useMemo, useState, useEffect } from "react";

/**
 * ROXO SABOR ‚Äî CARD√ÅPIO DIGITAL (Single-file React)
 * -------------------------------------------------
 * ‚úîÔ∏è Tema claro/escuro (persistente)
 * ‚úîÔ∏è Cupom / Raspadinha digital (campo + aplica√ß√£o de desconto)
 * ‚úîÔ∏è Carrinho fixo NA P√ÅGINA (sem flutuar)
 * ‚úîÔ∏è WhatsApp com mensagem autom√°tica
 * ‚úîÔ∏è Atalho iFood, categorias, busca, adicionais e tamanhos
 */

// ====== CONFIGURA√á√ïES DE MARCA E LOJA ======
const BRAND = {
  name: "Roxo Sabor",
  logoText: "ROXO SABOR",
  colors: {
    primary: "#6D28D9",
    primaryDark: "#4C1D95",
    accent: "#22C55E",
    lightBg: "#f9f9fb",
    lightFg: "#222",
    darkBg: "#0b0b0b",
    darkFg: "#eaeaea",
    cardDark: "#121212",
    cardLight: "#ffffff",
  },
};

const STORE = {
  whatsapp: "+55 31 993006358", // <-- COLOQUE SEU N√öMERO AQUI
  instagram: "@roxosaboroficial",
  ifoodUrl: "https://www.ifood.com.br/", // <-- SUBSTITUA PELO LINK DA SUA LOJA
  deliveryHours: "Todos os dias, 14h √†s 23h",
  raspadinhaCopy:
    "Raspou, achou, ganhou! Digite seu c√≥digo para validar seu pr√™mio.",
};

// C√≥digos de raspadinha/cupom (exemplo)
// type:"percent" aplica % no subtotal; type:"msg" apenas exibe mensagem (ex.: frete gr√°tis)
const COUPONS = {
  ROXO10: { type: "percent", value: 10, label: "10% de desconto aplicado" },
  FRETEGRATIS: { type: "msg", label: "Frete gr√°tis na pr√≥xima compra!" },
  ADICIONAL: { type: "msg", label: "Um adicional gr√°tis no pr√≥ximo a√ßa√≠!" },
};

// ====== DADOS DO CARD√ÅPIO (exemplo ‚Äî edite √† vontade) ======
const CATEGORIES = [
  { id: "promos", name: "Promo√ß√µes" },
  { id: "acai", name: "A√ßa√≠ no Copo" },
  { id: "combos", name: "Combos" },
  { id: "adicionais", name: "Adicionais" },
  { id: "bebidas", name: "Bebidas" },
];

const ADDONS = [
  { id: "leiteNinho", name: "Leite Ninho", price: 3.5 },
  { id: "nutella", name: "Nutella", price: 4.5 },
  { id: "morango", name: "Morango", price: 3.0 },
  { id: "banana", name: "Banana", price: 2.5 },
  { id: "granola", name: "Granola", price: 2.0 },
  { id: "leiteCondensado", name: "Leite Condensado", price: 2.5 },
];

const PRODUCTS = [
  // PROMO√á√ïES
  {
    id: "promo-999",
    category: "promos",
    name: "PROMO ‚Ä¢ 330 ml por R$ 9,99",
    desc: "A√ßa√≠ 330 ml com 1 adicional simples.",
    price: 9.99,
    img: "/placeholder.svg?height=120&width=160",
    tags: ["promo", "popular"],
  },
  // A√áA√ç
  {
    id: "acai-330",
    category: "acai",
    name: "A√ßa√≠ 330 ml",
    desc: "Base cremosa de a√ßa√≠. Escolha seus adicionais.",
    price: 14.9,
    sizes: [
      { code: "330", label: "330 ml", price: 14.9 },
      { code: "500", label: "500 ml", price: 19.9 },
      { code: "700", label: "700 ml", price: 26.9 },
    ],
    img: "/placeholder.svg?height=120&width=160",
    tags: ["popular"],
  },
  {
    id: "acai-gourmet",
    category: "acai",
    name: "A√ßa√≠ Gourmet",
    desc: "Com Nutella, Ninho e morangos frescos.",
    price: 24.9,
    img: "/placeholder.svg?height=120&width=160",
    tags: ["gourmet"],
  },
  // COMBOS
  {
    id: "combo-duo",
    category: "combos",
    name: "Combo DUO (2 x 500 ml)",
    desc: "2 copos de 500 ml + 2 adicionais cada.",
    price: 36.9,
    img: "/placeholder.svg?height=120&width=160",
    tags: ["fam√≠lia"],
  },
  // ADICIONAIS COMO LISTA
  ...ADDONS.map((a) => ({
    id: `addon-${a.id}`,
    category: "adicionais",
    name: a.name,
    desc: "Adicional avulso",
    price: a.price,
    img: "/placeholder.svg?height=120&width=160",
  })),
];

// ====== HELPERS ======
const currency = (n) => n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

const buildWhatsAppLink = ({ cart, note, total, couponCode }) => {
  const number = STORE.whatsapp.replace(/\D/g, "");
  const lines = [
    `üçß *${BRAND.name}* ‚Äî Novo Pedido`,
    "",
    ...cart.map((i, idx) => {
      const addons = i.addons?.length
        ? `\n  ‚Ä¢ Adicionais: ${i.addons.map((a) => a.name).join(", ")}`
        : "";
      const size = i.size ? ` (${i.size.label})` : "";
      return `${idx + 1}. ${i.name}${size} ‚Äî ${currency(i.subtotal)}${addons}`;
    }),
    "",
    couponCode ? `Cupom/Raspadinha: ${couponCode}` : "",
    `Total: *${currency(total)}*`,
    note ? `\nObserva√ß√µes: ${note}` : "",
    `Origem: Card√°pio Digital ${BRAND.name}`,
  ]
    .filter(Boolean)
    .join("\n");
  return `https://wa.me/${number}?text=${encodeURIComponent(lines)}`;
};

// ====== COMPONENTE PRINCIPAL ======
export default function RoxoSaborMenu() {
  // Tema
  const [theme, setTheme] = useState(() => localStorage.getItem("themeRS") || "dark");
  useEffect(() => {
    document.documentElement.classList.toggle("dark", theme === "dark");
    localStorage.setItem("themeRS", theme);
  }, [theme]);

  const [query, setQuery] = useState("");
  const [category, setCategory] = useState("promos");
  const [cart, setCart] = useState([]);
  const [note, setNote] = useState("");

  // Cupom
  const [couponCode, setCouponCode] = useState("");
  const [couponInfo, setCouponInfo] = useState(null);

  const filtered = useMemo(() => {
    return PRODUCTS.filter((p) =>
      (category ? p.category === category : true) &&
      (query ? (p.name + " " + (p.desc || "")).toLowerCase().includes(query.toLowerCase()) : true)
    );
  }, [category, query]);

  const subtotal = cart.reduce((s, i) => s + i.subtotal, 0);
  const discount = couponInfo?.type === "percent" ? (subtotal * couponInfo.value) / 100 : 0;
  const total = Math.max(0, subtotal - discount);

  function addToCart(product, { size, addons = [] } = {}) {
    const basePrice = size ? size.price : product.price;
    const addonsTotal = addons.reduce((s, a) => s + a.price, 0);
    const subtotal = basePrice + addonsTotal;

    setCart((old) => [
      ...old,
      {
        id: `${product.id}-${Date.now()}`,
        productId: product.id,
        name: product.name,
        size: size || null,
        addons,
        subtotal,
      },
    ]);
  }

  function removeFromCart(id) {
    setCart((old) => old.filter((i) => i.id !== id));
  }

  function clearCart() {
    setCart([]);
    setNote("");
  }

  function applyCoupon() {
    const code = couponCode.trim().toUpperCase();
    const found = COUPONS[code];
    if (found) setCouponInfo({ ...found, code });
    else setCouponInfo({ type: "msg", label: "C√≥digo inv√°lido ou j√° utilizado." });
  }

  return (
    <div className="min-h-screen text-[15px] bg-[--bg] text-[--fg] transition-colors">
      {/* HEADER */}
      <header className="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-black/40 bg-black/20 border-b border-white/10">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-purple-500 to-fuchsia-600 grid place-items-center font-extrabold">ü´ê</div>
          <div className="mr-auto">
            <div className="text-sm opacity-80">{BRAND.name}</div>
            <div className="text-xs opacity-60">{STORE.deliveryHours}</div>
          </div>

          <button
            onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
            className="px-3 py-1.5 rounded-xl border border-white/10 bg-white/10 hover:bg-white/20"
          >
            {theme === "dark" ? "üåû Claro" : "üåô Escuro"}
          </button>

          <a
            href={STORE.ifoodUrl}
            target="_blank"
            rel="noreferrer"
            className="hidden sm:inline-block px-3 py-1.5 rounded-xl bg-white/10 hover:bg-white/20 transition border border-white/10"
          >
            Pedir no iFood
          </a>

          <a href="#carrinho" className="px-3 py-1.5 rounded-xl bg-[--primary] hover:opacity-90 transition">
            Carrinho ({cart.length})
          </a>
        </div>
      </header>

      {/* HERO / BANNER */}
      <section className="max-w-6xl mx-auto px-4 pt-8 pb-4">
        <div className="grid md:grid-cols-[1.2fr_.8fr] gap-4">
          <div className="rounded-2xl p-6 bg-[--card] border border-white/10 shadow-xl">
            <h1 className="text-2xl sm:text-3xl font-extrabold tracking-tight">{BRAND.logoText}</h1>
            <p className="mt-1 opacity-80">Sua dose di√°ria de energia e sabor.</p>

            <div className="mt-4 flex flex-wrap gap-2">
              {CATEGORIES.map((c) => (
                <button
                  key={c.id}
                  onClick={() => setCategory(c.id)}
                  className={`px-3 py-1.5 rounded-xl border transition ${
                    category === c.id ? "bg-white/10 border-white/20" : "bg-transparent border-white/10 hover:bg-white/5"
                  }`}
                >
                  {c.name}
                </button>
              ))}
            </div>

            <div className="mt-4">
              <input
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Buscar no card√°pio‚Ä¶"
                className="w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 outline-none"
              />
            </div>

            <div className="mt-4 text-sm rounded-2xl bg-purple-600/15 border border-purple-500/30 p-4">
              <div className="font-semibold">üéüÔ∏è Raspadinha Roxo Sabor</div>
              <p className="opacity-90">{STORE.raspadinhaCopy}</p>
              <div className="mt-3 flex flex-col sm:flex-row gap-2 items-start sm:items-center">
                <input
                  value={couponCode}
                  onChange={(e) => setCouponCode(e.target.value)}
                  placeholder="Digite seu c√≥digo"
                  className="w-full sm:w-64 px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none"
                />
                <button onClick={applyCoupon} className="px-3 py-2 rounded-xl bg-[--primary] hover:opacity-90">
                  Validar c√≥digo
                </button>
              </div>
              {couponInfo && (
                <div className="mt-2 text-xs px-3 py-2 rounded-lg border border-white/10 bg-black/30">
                  ‚úÖ {couponInfo.label}
                </div>
              )}
            </div>
          </div>

          <div className="rounded-2xl p-6 bg-[--card] border border-white/10 shadow-xl">
            <div className="text-sm opacity-80">Atalho r√°pido</div>
            <div className="mt-2 grid gap-2">
              <a
                href={STORE.ifoodUrl}
                target="_blank"
                rel="noreferrer"
                className="px-4 py-3 rounded-xl bg-white/10 hover:bg-white/20 transition text-center"
              >
                Pedir pelo iFood
              </a>
              <a
                href={`https://wa.me/${STORE.whatsapp.replace(/\D/g, "")}`}
                target="_blank"
                rel="noreferrer"
                className="px-4 py-3 rounded-xl bg-[--primary] hover:opacity-90 transition text-center"
              >
                Falar no WhatsApp
              </a>
              <div className="text-xs opacity-60">{STORE.instagram} ‚Ä¢ Entrega {STORE.deliveryHours}</div>
            </div>
          </div>
        </div>
      </section>

      {/* LISTA DE PRODUTOS */}
      <main className="max-w-6xl mx-auto px-4 pb-14">
        <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {filtered.map((p) => (
            <ProductCard key={p.id} product={p} onAdd={addToCart} />
          ))}
        </div>
      </main>

      {/* CARRINHO (SE√á√ÉO EST√ÅTICA) */}
      <section id="carrinho" className="max-w-6xl mx-auto px-4 pb-12">
        <div className="rounded-2xl overflow-hidden border border-white/10 bg-[--card] shadow-2xl">
          <div className="grid md:grid-cols-[2fr_1fr] gap-0">
            {/* ITENS */}
            <div className="p-4">
              <div className="flex items-center justify-between">
                <h2 className="text-lg font-bold tracking-tight">Seu pedido</h2>
                {cart.length > 0 && (
                  <button onClick={clearCart} className="text-sm opacity-70 hover:opacity-100">Limpar</button>
                )}
              </div>

              {cart.length === 0 ? (
                <div className="py-8 text-sm opacity-70">Seu carrinho est√° vazio. Adicione itens do card√°pio para finalizar o pedido.</div>
              ) : (
                <ul className="mt-3 divide-y divide-white/10">
                  {cart.map((i) => (
                    <li key={i.id} className="py-3 flex gap-3 items-start">
                      <div className="w-10 h-10 rounded-lg bg-black/30 grid place-items-center">üçß</div>
                      <div className="grow">
                        <div className="font-medium leading-tight">
                          {i.name}
                          {i.size ? <span className="opacity-70"> ({i.size.label})</span> : null}
                        </div>
                        {i.addons?.length ? (
                          <div className="text-xs opacity-70">Adicionais: {i.addons.map((a) => a.name).join(", ")}</div>
                        ) : null}
                        <div className="text-sm mt-1">{currency(i.subtotal)}</div>
                      </div>
                      <button onClick={() => removeFromCart(i.id)} className="px-2 py-1 rounded-lg border border-white/10 hover:bg-white/5 text-xs">remover</button>
                    </li>
                  ))}
                </ul>
              )}
            </div>

            {/* RESUMO */}
            <CartSummary
              subtotal={subtotal}
              discount={discount}
              total={total}
              note={note}
              setNote={setNote}
              cart={cart}
              couponCode={couponInfo?.code}
            />
          </div>
        </div>
      </section>

      <footer className="py-10 text-center text-xs opacity-60">
        <div>{BRAND.name} ‚Ä¢ {STORE.deliveryHours}</div>
        <div>Feito com ‚ù§Ô∏è para vender mais a√ßa√≠</div>
      </footer>

      <style jsx global>{`
        :root{
          --primary:${BRAND.colors.primary};
          --primaryDark:${BRAND.colors.primaryDark};
          --accent:${BRAND.colors.accent};
          --bg:${BRAND.colors.darkBg};
          --fg:${BRAND.colors.darkFg};
          --card:${BRAND.colors.cardDark};
        }
        :root.light{
          --bg:${BRAND.colors.lightBg};
          --fg:${BRAND.colors.lightFg};
          --card:${BRAND.colors.cardLight};
        }
        html.light, html.light body { background: var(--bg); color: var(--fg); }
        html.dark, html.dark body  { background: var(--bg); color: var(--fg); }
      `}</style>

      {/* sincroniza classe html light/dark */}
      <ThemeBinder theme={theme} />
    </div>
  );
}

function ThemeBinder({ theme }){
  useEffect(() => {
    const html = document.documentElement;
    html.classList.remove("light","dark");
    html.classList.add(theme === "dark" ? "dark" : "light");
  }, [theme]);
  return null;
}

// ====== CART SUMMARY ======
function CartSummary({ subtotal, discount, total, note, setNote, cart, couponCode }){
  const waLink = useMemo(() => buildWhatsAppLink({ cart, note, total, couponCode }), [cart, note, total, couponCode]);

  return (
    <div className="p-4 border-t md:border-t-0 md:border-l border-white/10 bg-black/10">
      <div className="grid gap-3">
        <div className="grid gap-1 text-sm">
          <label className="opacity-80">Observa√ß√µes do pedido</label>
          <textarea
            rows={3}
            value={note}
            onChange={(e) => setNote(e.target.value)}
            placeholder="Ex.: Sem granola, pouco leite condensado‚Ä¶"
            className="w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none"
          />
        </div>

        <div className="flex items-center justify-between text-sm pt-2">
          <span>Subtotal</span>
          <span>{currency(subtotal)}</span>
        </div>
        {discount > 0 && (
          <div className="flex items-center justify-between text-sm">
            <span>Desconto ({couponCode})</span>
            <span>- {currency(discount)}</span>
          </div>
        )}
        <div className="flex items-center justify-between text-base font-semibold border-t border-white/10 pt-2">
          <span>Total</span>
          <span>{currency(total)}</span>
        </div>

        <a
          href={waLink}
          target="_blank"
          rel="noreferrer"
          className={`mt-2 px-4 py-3 rounded-xl text-center font-medium ${
            cart.length === 0 ? "pointer-events-none opacity-50 bg-white/10" : "bg-[--primary] hover:opacity-90"
          }`}
        >
          Enviar pedido no WhatsApp
        </a>
        <a
          href={STORE.ifoodUrl}
          target="_blank"
          rel="noreferrer"
          className="px-4 py-3 rounded-xl text-center font-medium bg-white/10 hover:bg-white/20"
        >
          Preferir iFood
        </a>
      </div>
    </div>
  );
}

// ====== CART√ÉO DE PRODUTO ======
function ProductCard({ product, onAdd }) {
  const [open, setOpen] = useState(false);
  const [selectedSize, setSelectedSize] = useState(product.sizes ? product.sizes[0] : null);
  const [chosenAddons, setChosenAddons] = useState([]);

  const addonsTotal = chosenAddons.reduce((s, a) => s + a.price, 0);
  const currentPrice = (selectedSize ? selectedSize.price : product.price) + addonsTotal;

  function toggleAddon(addon) {
    setChosenAddons((old) => {
      const exists = old.find((a) => a.id === addon.id);
      if (exists) return old.filter((a) => a.id !== addon.id);
      return [...old, addon];
    });
  }

  return (
    <div className="rounded-2xl overflow-hidden border border-white/10 bg-[--card] flex flex-col">
      <div className="aspect-[4/3] bg-black/20 grid place-items-center text-4xl">üçß</div>
      <div className="p-4 grow flex flex-col">
        <div className="font-semibold text-lg leading-tight">{product.name}</div>
        {product.desc && <p className="mt-1 opacity-75 text-sm">{product.desc}</p>}

        {product.sizes && (
          <div className="mt-3 flex flex-wrap gap-2">
            {product.sizes.map((s) => (
              <button
                key={s.code}
                onClick={() => setSelectedSize(s)}
                className={`px-2.5 py-1.5 rounded-lg border text-sm transition ${
                  selectedSize?.code === s.code ? "bg-white/10 border-white/20" : "bg-transparent border-white/10 hover:bg-white/5"
                }`}
              >
                {s.label} ‚Ä¢ {currency(s.price)}
              </button>
            ))}
          </div>
        )}

        {/* Adicionais */}
        <details className="mt-3">
          <summary className="cursor-pointer text-sm opacity-80 select-none">Adicionar complementos</summary>
          <div className="mt-2 grid grid-cols-2 gap-2">
            {ADDONS.map((a) => (
              <label key={a.id} className="flex items-center gap-2 text-sm p-2 rounded-lg bg-black/30 border border-white/10">
                <input
                  type="checkbox"
                  checked={!!chosenAddons.find((x) => x.id === a.id)}
                  onChange={() => toggleAddon(a)}
                />
                <span className="grow">{a.name}</span>
                <span className="opacity-80">{currency(a.price)}</span>
              </label>
            ))}
          </div>
        </details>

        <div className="mt-auto pt-4 flex items-center justify-between">
          <div className="font-semibold">{currency(currentPrice)}</div>
          <div className="flex gap-2">
            {product.desc && (
              <button
                onClick={() => setOpen((v) => !v)}
                className="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5"
              >
                Detalhes
              </button>
            )}
            <button
              onClick={() => onAdd(product, { size: selectedSize, addons: chosenAddons })}
              className="px-3 py-2 rounded-xl bg-[--primary] hover:opacity-90"
            >
              Adicionar
            </button>
          </div>
        </div>

        {open && (
          <div className="mt-3 text-sm opacity-80 border-t border-white/10 pt-3">
            <p>{product.desc}</p>
            {product.tags?.length ? (
              <div className="mt-2 flex gap-2 flex-wrap">
                {product.tags.map((t) => (
                  <span key={t} className="px-2 py-0.5 rounded-lg bg-black/40 border border-white/10 text-xs">#{t}</span>
                ))}
              </div>
            ) : null}
          </div>
        )}
      </div>
    </div>
  );
}
